<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalentFlow - Oportunidades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top glass-card mx-3 mt-3 rounded-pill" style="border-radius: 50px !important;">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-workspace me-2"></i>TalentFlow <span class="badge bg-info small">Vagas</span></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#candNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="candNav">
                    <ul class="navbar-nav ms-auto align-items-center gap-3">
                        <li class="nav-item"><a class="nav-link active" href="dashboard-candidato.html">Meu Painel</a></li>
                        <li class="nav-item ms-3">
                            <button onclick="logout()" class="btn btn-outline-light rounded-pill px-3 btn-sm hover-scale">Sair</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <br><br><br><br><br>
        
        <section class="filtros-area d-flex gap-3 mb-4 flex-wrap">
            <input type="text" id="inputBusca" class="form-control glass-input w-auto flex-grow-1" placeholder="Pesquisar cargo..." oninput="listar()">
            
            <select id="selectEmpresa" class="form-select glass-input w-auto" onchange="listar()">
                <option value="">Todas as Empresas</option>
            </select>

            <select id="selectPaginacao" class="form-select glass-input w-auto" onchange="paginaAtual=0; itensPorPagina=(this.value=='all' ? vagas.length : parseInt(this.value)); listar();">
                <option value="4">Exibir 4</option>
                <option value="12" selected>Exibir 12</option>
                <option value="24">Exibir 24</option>
                <option value="all">Ver Todas</option>
            </select>
        </section>

        <div class="d-flex justify-content-end px-3 mb-2">
            <span id="contadorTopo" class="text-white-50 small fw-bold">0 / 0 vagas</span>
        </div>

        <div id="vagasGrid" class="row">
        </div>

        <footer class="pagination-footer d-flex justify-content-between align-items-center mt-4 mb-5 px-4">
            <div style="min-width: 150px;">
                <button id="btnVoltar" class="btn-glass" onclick="paginaAnterior()" style="display: none;">&larr; Anterior</button>
            </div>
            <div class="text-white fw-bold">
                Página <span id="numPagina">1 de 1</span>
            </div>
            <div style="min-width: 150px;" class="text-end">
                <button id="btnProximo" class="btn-glass" onclick="proximaPagina()">Próxima Página &rarr;</button>
            </div>
        </footer>
    </div>

    <div class="modal fade" id="modalVaga" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content glass-card border-light border-opacity-25 text-white shadow-lg">
                <div class="modal-header border-0 d-flex flex-column align-items-center text-center w-100 position-relative pt-5">
                    <h3 class="fw-bold mb-0 w-100" id="detalheTitulo" style="letter-spacing: 1px;">Título da Vaga</h3>
                    <p class="text-info mt-2 h5" id="detalheEmpresa">Nome da Empresa</p>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-3" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body px-5">
                    <hr class="border-light border-opacity-25 my-4">
                    <h6 class="fw-bold text-info text-uppercase small" style="letter-spacing: 2px;">Áreas da Vaga:</h6>
                    <p id="detalheArea" class="mb-4 text-light fs-5">Área</p>
                    
                    <hr class="border-light border-opacity-25 my-4">
                    <h6 class="fw-bold text-info text-uppercase small" style="letter-spacing: 2px;">Descrição:</h6>
                    <div id="detalheDescricao" class="text-light mb-5" style="white-space: pre-wrap; line-height: 1.8; text-align: justify;">
                        Descrição...
                    </div>
                </div>

                <div class="modal-footer border-0 pb-4 pe-5 d-flex justify-content-end">
                    <button type="button" id="btnCandidatar" class="btn btn-success btn-lg rounded-pill px-5 fw-bold hover-scale shadow">
                        Candidatar-se
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let vagas = [];
        let paginaAtual = 0;
        let itensPorPagina = 12;
        let vagaIdSelecionada = null;

        // 1. Busca as vagas (Geralmente público, não precisa de token aqui)
        async function getVagas() {
            try {
                const response = await fetch('https://talentflow-gfq3.onrender.com/vagas');
                if (response.ok) {
                    vagas = await response.json();
                    popularEmpresas();
                    listar();
                } else {
                    console.error('Erro ao obter as vagas.');
                }
            } catch (error) {
                console.error('Erro de conexão:', error);
            }
        }

        // 2. Renderiza os cards
        function listar() {
            const grid = document.getElementById('vagasGrid');
            grid.innerHTML = "";
            const pesquisa = document.getElementById('inputBusca').value.toLowerCase();
            const empresaFiltro = document.getElementById('selectEmpresa').value;

            const filtradas = vagas.filter(v => {
                const matchesTexto = v.titulo.toLowerCase().includes(pesquisa) || 
                                     v.descricao.toLowerCase().includes(pesquisa);
                const matchesEmpresa = empresaFiltro === "" || v.empresa.nome === empresaFiltro;
                return matchesTexto && matchesEmpresa;
            });

            const paraExibir = aplicarPaginacao(filtradas);

            paraExibir.forEach(vaga => {
                const col = document.createElement('div');
                console.log(vaga);
                col.classList.add('col-md-4', 'mb-4');
                col.innerHTML = `
                    <div class="vaga-item glass-card p-4 h-100 d-flex flex-column shadow-sm overflow-hidden hover-lift cursor-pointer" onclick='abrirModal(${JSON.stringify(vaga)})'>
                        <h4 class="fw-bold mb-2">${vaga.titulo}</h4>
                        <p class="text-info small mb-2"><i class="bi bi-building me-1"></i>${vaga.empresa.nome}</p>
                        <p class="text-white-50 small flex-grow-1">
                            ${vaga.descricao.substring(0, 80)}... 
                            <span class="text-info fw-bold" style="cursor:pointer" onclick='abrirModal(${JSON.stringify(vaga)})'>Ver mais</span>
                        </p>
                        <div class="mt-3">
                            <span class="badge bg-light text-dark rounded-pill">${vaga.area}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(col);
            });
        }

        function abrirModal(vaga) {
            vagaIdSelecionada = vaga.codVaga;
            document.getElementById('detalheTitulo').innerText = vaga.titulo;
            document.getElementById('detalheEmpresa').innerText = vaga.empresa.nome;
            document.getElementById('detalheArea').innerText = vaga.area;
            document.getElementById('detalheDescricao').innerText = vaga.descricao;

            const modal = new bootstrap.Modal(document.getElementById('modalVaga'));
            modal.show();
        }

        // 3. Lógica de Candidatura com TOKEN (Ajustado)
        document.getElementById('btnCandidatar').addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if(!token || !userStr) {
                alert("Sessão expirada ou usuário não identificado. Faça login novamente.");
                window.location.href = 'candidato-login.html';
                return;
            }

            const user = JSON.parse(userStr);
            // O DTO deve bater com CandidatoVagaRequestDTO.java
            const dto = {
                codCandidato: user.codCandidato, 
                codVaga: vagaIdSelecionada
            };
            
            const btn = document.getElementById('btnCandidatar');

            console.log("Enviando DTO:", dto);
            try {
                btn.disabled = true;
                btn.innerText = "Processando...";

                const response = await fetch('https://talentflow-gfq3.onrender.com/candidato-vaga', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Inclusão do Token
                    },
                    body: JSON.stringify(dto)
                });

                if (response.ok) {
                    alert("✅ Candidatura enviada com sucesso!");
                    bootstrap.Modal.getInstance(document.getElementById('modalVaga')).hide();
                } else {
                    const erroJson = await response.json().catch(() => ({}));
                    const mensagem = erroJson.message || "Erro desconhecido no servidor.";
                    alert("Ops! " + mensagem);
                }
            } catch (error) {
                console.error(error);
                alert("Erro ao conectar com o servidor.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Candidatar-se";
            }
        });

        // Auxiliares
        function popularEmpresas() {
            const sel = document.getElementById('selectEmpresa');
            const nomes = [...new Set(vagas.map(v => v.empresa.nome))];
            nomes.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n; opt.textContent = n;
                sel.appendChild(opt);
            });
        }

        function aplicarPaginacao(lista) {
            const total = lista.length;
            const totalPaginas = Math.ceil(total / itensPorPagina) || 1;
            if (paginaAtual >= totalPaginas) paginaAtual = 0;
            const inicio = paginaAtual * itensPorPagina;
            const fim = inicio + itensPorPagina;
            document.getElementById('contadorTopo').textContent = `${Math.min(fim, total)} / ${total} vagas`;
            document.getElementById('numPagina').textContent = `${paginaAtual + 1} de ${totalPaginas}`;
            document.getElementById('btnVoltar').style.display = paginaAtual > 0 ? 'inline-block' : 'none';
            document.getElementById('btnProximo').style.display = fim >= total ? 'none' : 'inline-block';
            return lista.slice(inicio, fim);
        }

        function proximaPagina() { paginaAtual++; listar(); }
        function paginaAnterior() { if(paginaAtual > 0) { paginaAtual--; listar(); } }
        
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        window.onload = getVagas;
    </script>
</body>
</html>