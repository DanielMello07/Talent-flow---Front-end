<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalentFlow - Oportunidades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top glass-card mx-3 mt-3 rounded-pill" style="border-radius: 50px !important;">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-workspace me-2"></i>TalentFlow <span class="badge bg-info small">Vagas</span></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#candNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="candNav">
                    <ul class="navbar-nav ms-auto align-items-center gap-3">
                        <li class="nav-item"><a class="nav-link active" href="index.html" onclick="showSection('inicio')">Início</a></li>
                        <li class="nav-item ms-3">
                            <a href="index.html" class="btn btn-outline-light rounded-pill px-3 btn-sm hover-scale">Entrar</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <br><br><br><br><br>
        
        <section class="filtros-area">
            <input type="text" id="inputBusca" placeholder="Pesquisar cargo..." oninput="listar()">
            
            <select id="selectEmpresa" onchange="listar()">
                <option value="">Todas as Empresas</option>
            </select>
            <script>
                let vagas=[];
                let paginaAtual = 0;
                let itensPorPagina = 12;

                async function getVagas() {
                    try {
                    // Backend espera JSON no Body
                        const response = await fetch('http://localhost:8080/vagas', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            console.log()
                            vagas = await response.json();
                            console.log(vagas);
                            
                            popularEmpresas();

                            aplicarPaginacao(vagas).forEach(vaga => {
                                console.log(vaga);
                            
                                //// CONTAINER DA VAGA
                                const vagaDiv = document.createElement('div');
                                vagaDiv.classList.add('vaga-item','glass-card', 'p-4', 'mb-3');
                                //// LINK DA VAGA
                                const vagaLink = document.createElement('a');
                                vagaLink.href = `index.html`;
                                vagaLink.classList.add('vaga-link')
                                vagaLink.appendChild(vagaDiv);
                                document.getElementById('vagasGrid').appendChild(vagaLink);
                                //// TÍTULO
                                const vagaTitulo = document.createElement('h3');
                                vagaTitulo.textContent = vaga.titulo;                                
                                vagaTitulo.classList.add('vaga-titulo','fw-bold', 'h4');
                                vagaDiv.appendChild(vagaTitulo);
                                //// DESCRIÇÃO
                                const vagaDescricao = document.createElement('p');
                                vagaDescricao.textContent = vaga.descricao;
                                vagaDescricao.classList.add('small', 'text-white-50');
                                vagaDescricao.classList.add('vaga-descricao');
                                vagaDiv.appendChild(vagaDescricao);
                                //// ÁREA
                                const vagaArea = document.createElement('p');
                                vagaArea.textContent = vaga.area;
                                vagaDiv.appendChild(vagaArea);
                                //// EMPRESA
                                const vagaEmpresa = document.createElement('p');
                                vagaEmpresa.textContent = vaga.empresa.nome;
                                vagaDiv.appendChild(vagaEmpresa);

                                

                            });
                        } 
                        else
                        {
                            console.log('Erro ao obter as vagas do servidor.');                            
                        }
                    } catch (error) {
                        console.log('Erro ao conectar com o servidor.');
                        console.error(error);
                    } 
                }


                function listar() {
                    // 1. Limpa o grid para a nova filtragem (ou nova página)
                    const grid = document.getElementById('vagasGrid');
                    grid.innerHTML = "";

                    // 2. Captura os valores dos inputs
                    const pesquisa = document.getElementById('inputBusca').value.toLowerCase();
                    const empresaFiltro = document.getElementById('selectEmpresa').value;

                    // 3. Filtra a partir da variável global 'vagas'
                    const vagasFiltradas = vagas.filter(vaga => {
                        const matchesTexto = vaga.titulo.toLowerCase().includes(pesquisa) || 
                                            vaga.descricao.toLowerCase().includes(pesquisa);
                        const matchesEmpresa = empresaFiltro === "" || 
                                            vaga.empresa.nome === empresaFiltro;
                        return matchesTexto && matchesEmpresa;
                    });

                    // --- AJUSTE AQUI ---
                    // 4. Aplica a paginação sobre a lista já filtrada
                    const vagasParaExibir = aplicarPaginacao(vagasFiltradas);

                    // 5. Faz o loop apenas nas vagas da página atual
                    vagasParaExibir.forEach(vaga => {
                        const vagaDiv = document.createElement('div');
                        vagaDiv.classList.add('vaga-item','glass-card', 'p-4', 'mb-3');
                        
                        const vagaLink = document.createElement('a');
                        vagaLink.href = `index.html`;
                        vagaLink.classList.add('vaga-link');
                        
                        const vagaTitulo = document.createElement('h3');
                        vagaTitulo.textContent = vaga.titulo;                                
                        vagaTitulo.classList.add('vaga-titulo','fw-bold', 'h4');
                        vagaDiv.appendChild(vagaTitulo);
                        
                        const vagaDescricao = document.createElement('p');
                        vagaDescricao.textContent = vaga.descricao;
                        vagaDescricao.classList.add('small', 'text-white-50', 'vaga-descricao');
                        vagaDiv.appendChild(vagaDescricao);
                        
                        const vagaArea = document.createElement('p');
                        vagaArea.textContent = vaga.area;
                        vagaDiv.appendChild(vagaArea);
                        
                        const vagaEmpresa = document.createElement('p');
                        vagaEmpresa.textContent = vaga.empresa.nome;
                        vagaDiv.appendChild(vagaEmpresa);

                        vagaLink.appendChild(vagaDiv);
                        grid.appendChild(vagaLink);
                    });

                }

                function popularEmpresas() {
                    const selectEmpresa = document.getElementById('selectEmpresa');
                    const empresasUnicas = [...new Set(vagas.map(vaga => vaga.empresa.nome))];

                    empresasUnicas.forEach(empresaNome => {
                        const option = document.createElement('option');
                        option.textContent = empresaNome;
                        selectEmpresa.appendChild(option);
                    });
                }

                function aplicarPaginacao(listaCompleta) {
                    const totalVagas = listaCompleta.length;

                    // Cálculo de quantos itens estão sendo exibidos (ex: 12/500, 24/500)
                    // Usamos Math.min para não mostrar um número maior que o total na última página
                    
                    const totalPaginas = Math.ceil(totalVagas / itensPorPagina) || 1;

                    if (paginaAtual >= totalPaginas) {
                        paginaAtual = 0;
                    }
                    
                    const inicio = paginaAtual * itensPorPagina;
                    const fim = inicio + itensPorPagina;
                    const exibidosAteAgora = Math.min(fim, totalVagas);
                    // 1. Atualiza o contador do topo (ex: 12 / 500)
                    const contadorTopo = document.getElementById('contadorTopo');
                    if (contadorTopo) {
                        contadorTopo.textContent = `${exibidosAteAgora} / ${totalVagas} vagas`;
                    }

                    // 2. Atualiza o indicador do rodapé (ex: Página 1 de 12)
                    const indicadorPagina = document.getElementById('numPagina');
                    if (indicadorPagina) {
                        indicadorPagina.textContent = `${paginaAtual + 1} de ${totalPaginas}`;
                    }

                    // 3. Controle dos botões
                    const btnProximo = document.getElementById('btnProximo');
                    if (btnProximo) {
                        btnProximo.style.display = fim >= totalVagas ? 'none' : 'inline-block';
                    }

                    const btnVoltar = document.getElementById('btnVoltar');
                    if (btnVoltar) {
                        btnVoltar.style.display = paginaAtual > 0 ? 'inline-block' : 'none';
                    }
                    
                    return listaCompleta.slice(inicio, fim);
                }

                function proximaPagina() {
                    paginaAtual++;
                    listar();
                }

                function paginaAnterior() {
                    if (paginaAtual > 0) {
                        paginaAtual--;
                        listar();
                    }
                }

                window.onload = getVagas();
                
            </script>

            <select id="selectPaginacao" onchange="paginaAtual=0; itensPorPagina=(this.value=='all' ? vagas.length : parseInt(this.value)); listar();">
                <option value="4">Exibir 4</option>
                <option value="12" selected>Exibir 12</option>
                <option value="24">Exibir 24</option>
                <option value="all">Ver Todas</option>
            </select>
            
        </section>

        <div id="ListaVagas" class="p-4"></div>
        
        <div class="d-flex justify-content-end px-3 mb-2">
            <span id="contadorTopo" class="text-white-50 small fw-bold">0 / 0 vagas</span>
        </div>

        <div id="vagasGrid" class="vagas-grid">
            </div>
        <footer class="pagination-footer d-flex justify-content-between align-items-center mt-4 mb-5 px-4">
            <div style="min-width: 150px;">
                <button id="btnVoltar" class="btn-glass" onclick="paginaAnterior()" style="display: none;">&larr; Anterior</button>
            </div>

            <div class="text-white fw-bold">
                Página <span id="numPagina">1 de 1</span>
            </div>

            <div style="min-width: 150px;" class="text-end">
                <button id="btnProximo" class="btn-glass" onclick="proximaPagina()">Próxima Página &rarr;</button>
            </div>
        </footer>
    </div>

    <script src="js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>